# 存储引擎

![mysql-engine](https://tva1.sinaimg.cn/large/008i3skNgy1grrexlqqpbj308h04l0sl.jpg)

## MySQL体系结构

MySQL使用了一种称之为“**插件式存储引擎**”的体系结构，这种体系结构将数据的存储和处理进行的解耦，使得数据的的处理不再依赖于数据的存储，所以我们可以根据不同引擎的特性来选择合适的数据库存储引擎。

需要注意的是，MySQL的中存储引擎是基于表的，而不是基于库的，这就意味着，我们可以在MySQL数据库中对不同的表选择不同的存储引擎。

![mysql-architecture](https://tva1.sinaimg.cn/large/008i3skNgy1grrfejpi3yj30kc0ghdgv.jpg)

MySQL Server架构是典型的“客户端+服务端架构”，自顶向下大致可以分网络连接层、服务层、存储引擎层和系统文件层。

### 网络连接层
* 客户端连接器（Client Connectors）：提供与MySQL服务器建立的支持。目前几乎支持所有主流 的服务端编程技术，例如常见的 Java、C、Python、.NET等，它们通过各自API技术与MySQL建立连接

### 服务层（MySQL Server）
* 连接池（Connection Pool）：负责存储和管理客户端与数据库的连接，一个线程负责管理一个连接。
* 系统管理和控制工具（Management Services & Utilities）：例如备份恢复、安全管理、集群管理等
* SQL接口（SQL Interface）：用于接受客户端发送的各种SQL命令，并且返回用户需要查询的结果。比如DML、DDL、存储过程、视图、触发器等。
* 解析器（Parser）：负责将请求的SQL解析生成一个"解析树"。然后根据一些MySQL规则进一步检查解析树是否合法。
* 查询优化器（Optimizer）：当“解析树”通过解析器语法检查后，将交由优化器将其转化成执行计划，然后与存储引擎交互。
* 缓存（Cache&Buffer）： 缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，权限缓存，引擎缓存等。如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。

### 存储引擎层（Pluggable Storage Engines）
存储引擎负责MySQL中数据的存储与提取，与底层系统文件进行交互。MySQL存储引擎是插件式的，服务器中的查询执行引擎通过接口与存储引擎进行通信，接口屏蔽了不同存储引擎之间的差异。本节我们将着重介绍常见的几种存储引擎。

### 系统文件层（File System）
该层负责将数据库的数据和日志存储在文件系统之上，并完成与存储引擎的交互，是文件的物理存储层。主要包含日志文件，数据文件，配置文件，pid 文件，socket 文件等。

## 常见存储引擎概述
MySQL的存储引擎比较丰富，特性也不一致，这里我们介绍一些常见的存储引擎供大家选择。

### MyISAM

此存储引擎是MySQL5.5之前默认的存储引擎，此存储引擎是MySQL大部分系统表、临时表等使用的存储引擎。

MyISAM存储引擎在数据库中将表分为MYD和MYI组成，分别代表数据文件和索引文件。

**MyISAM存储引擎的特性：**
* MyISAM存储引擎使用的是表级锁，而非行级锁，这就意味着如果对这个表的数据进行修改时，需要对真个表进行加锁，而对表进行读取时，需要加共享锁，所以，此存储引擎对于读写操作时互斥的，这就意味着，该存储引擎的并发性并不好。
* 表损坏修复：MyISAM存储引擎支持对任一表由于意味关闭而导致的损坏进行修复，这里所说的修复并非是事务修复，因为此存储引擎不支持事务。所以这种损坏修复有可能导致数据的丢失。可以使用命令`check table [tablename]`来检查表是否需要修复，使用`repair table [tablename]`命令来进行修复。
* MyISAM存储引擎支持全文索引，还支持前缀索引。
* MyISAM存储引擎支持数据压缩操作，所以对于存储空间要求比较高的数据库，这是一个不错的选择。可以使用命令`myisampack`来压缩表中的数据。需要注意的是，压缩表只能支持只读。
* MySQL版本如果小于5.0，需要注意默认表的大小为4G

综上所述，MyISAM存储引擎比较适合于非事务性应用，对只读类应用支持较好。

### InnoDB

自从MySQL5.5之后，默认存储引擎就切换为InnoDB啦，自此之后，InnoDB凭借着强劲的性能优势，事务，行级锁而成为MySQL主打的存储引擎。

InnoDB使用表空间来存储数据，通过参数`innodb_file_per_table`来设置：
* 如果为ON，表示使用独立表空间。
* 如果为OFF，表示使用系统表空间。
MySQL5.6之后，这个参数默认设置为ON，由于系统表空间固有的问题，我们强烈推荐使用独立表空间来存储数据，如果你使用了系统表空间来存储数据，可以使用以下方法来转移：
1.使用mysqldump导出数据库所有数据和表结构。
2.停止mysql服务，修改参数`innodb_file_per_table`，并删除原有的相关数据库文件。
3.重启mysql服务，重建InnoDB系统表空间
4.导入数据

InnoDB是一种事务型存储引擎，完全支持事务的ACID特性。此存储引擎通过下面两种Log来实现的：
* Redo Log：主要实现事务的持久性，主要为已经提交的事务，一般顺序写入
* Undo Log：主要实现事务回滚和MVCC，主要为未提交的事务，需要随机读写，可以独立于表空间存在

InnoDB支持行级锁，可以最大程度的支持并发。行级锁是在存储引擎层实现的，对于MySQL来说完全不了解锁的实现方式。锁主要用于管理共享资源的并发访问，主要用于实现事务的隔离性。数据库中，锁主要分为一下两种：
* 共享锁：也称之为读锁，共享锁锁定的资源对其他共享锁也是可见的。
* 独占锁：也称之为写锁，写锁具有排他性，与任何其他锁都无法兼容。
需要注意的是，MySQL中的锁时行级锁，所以，仅仅是对这一行数据而言的。

InnoDB还为开发中提供了一种独特的状态检查工具，可以使用命令`show engine innodb status;`来查看。

综上所述，除了一些特殊的情况，我们均推荐使用使用InnoDB作为存储引擎。

### CSV

前面我们学习的MyISAM和InnoDB存储引擎，他们的数据在数据库中均以二进制的形式存放，而CSV存储引擎是以csv文件的形式存放在数据库中，我们可以直接使用文件编辑的命令来操作这个文件，只要不损坏这个文件的格式，那么此存储引擎就可以将此文件当做表来处理。

CSV存储引擎生成的表有以下几个文件：
* `.csv文件`：存储表的数据以及内容
* `csm文件`：主要存储表的元数据如表状态和数据量
* `.frm文件`：存储表的结构信息

需要注意的是，CSV存储引擎有以下几个规范：
* 所有的列都是不能为null的
* 不支持索引，不适合大表，不适合在线处理
* 可以对数据文件直接编辑

综上所述，这种存储引擎适合于存储数据交换的中间表，我们可以将Excel中的数据文件导入成csv文件，这样MySQL就可以直接读取数据啦！

### Archive

Archive存储引擎以zlib为基础，可以对数据表进行压缩，这样磁盘I/O的占比会更少。是所有存储引擎中最节约空间的引擎。Archive存储引擎将数据存储在`ARZ`为后缀的文件中。

主要有以下特点：
* 只支持insert和select操作。
* 本身并不是事务性的存储引擎，但是它模仿了事务性存储引擎的特点。
* 只允许在自增ID列上加索引。

综上所述，由于此存储引擎最节约空间，我们可以在一些日志存储类、数据采集类、报表类应用中使用。

### Memory

Memory存储引擎也称之为HEAP存储引擎，顾名思义，我们就可以知道这种存储引擎将数据存储在内存中，所以，如果一旦MySQL服务器重启，所有的数据将会丢失。但是memory存储引擎的表结构不会丢失，因为表结构存储在`.frm`文件中。

功能特点：
* 支持HASH索引和BTree索引，对于等值查找，HASH索引的查找效率最高，对于范围查找，Btree索引的查找效率最高。
* 所有的字段都以固定长度存储。这就要求我们在建表时使用最小的符合要求的数据格式。
* 不支持BLOG和TEXT等大字段。
* 存储引擎使用表级锁。
* 表的最大大小由max_heap_table_size参数决定，默认值为16M，需要使用时特别注意。

综上所述，Memory数据易丢失，所以要求数据是可以再生的，通常有以下使用场景：
* 用于查找或者是映射表，例如邮编和地区的对应表。
* 用于保存数据分析中产生的中间表。
* 用于缓存周期性聚合数据的结果表。

## 数据库存储引擎的选择

大部分情况下，选择InnoDB都没有错误，一般情况下，选择一款合适的存储引擎需要考虑下面几个因素：
* 是否需要知识事务？
* 查询、插入、修改、删除的占比
* 数据的备份？热备还是冷备？
* 奔溃恢复，大型数据库如果崩溃能否在线恢复？

